# Sherpa-ONNX æ‰‹åŠ¨é›†æˆæŒ‡å—

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-16
**é—®é¢˜**: Sherpa-ONNX æ²¡æœ‰å®˜æ–¹ Maven ä»“åº“ï¼Œéœ€è¦æ‰‹åŠ¨é›†æˆ

---

## âš ï¸ å½“å‰çŠ¶æ€

è¯­éŸ³åŠŸèƒ½çš„ä»£ç å·²ç»å®Œæ•´å®ç°ï¼Œä½†ç”±äº Sherpa-ONNX åº“çš„é›†æˆé—®é¢˜ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ ä¾èµ–ã€‚

### å·²å®ç°çš„ä»£ç 
- âœ… éŸ³é¢‘å½•åˆ¶æ¨¡å— (`AudioRecorder.kt`)
- âœ… ASR å¼•æ“æ¥å£ (`IAsrEngine.kt`, `SherpaOnnxAsrEngine.kt`)
- âœ… è¯­éŸ³è¾“å…¥ UI (`VoiceInputView.kt`)
- âœ… èŠå¤©ç•Œé¢é›†æˆ (`ChatActivityWithVoice.kt`)

### å¾…è§£å†³çš„ä¾èµ–
- â³ Sherpa-ONNX Android åº“é›†æˆ

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: æ‰‹åŠ¨ä¸‹è½½ AAR æ–‡ä»¶ï¼ˆæ¨èï¼‰

#### 1. ä¸‹è½½é¢„ç¼–è¯‘ AAR

è®¿é—® [Sherpa-ONNX Releases](https://github.com/k2-fsa/sherpa-onnx/releases)ï¼Œä¸‹è½½æœ€æ–°çš„ Android AARï¼š

```bash
# ç¤ºä¾‹ï¼šv1.10.30
https://github.com/k2-fsa/sherpa-onnx/releases/download/v1.10.30/sherpa-onnx-v1.10.30-android.tar.bz2
```

#### 2. è§£å‹å¹¶æå– AAR

```bash
tar -xjf sherpa-onnx-v1.10.30-android.tar.bz2
cd sherpa-onnx-v1.10.30-android
```

æ‰¾åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š
```
sherpa-onnx-android-1.10.30.aar
```

#### 3. æ”¾ç½®åˆ°é¡¹ç›®ä¸­

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º libs ç›®å½•
mkdir -p app/libs

# å¤åˆ¶ AAR æ–‡ä»¶
cp sherpa-onnx-android-1.10.30.aar app/libs/
```

#### 4. ä¿®æ”¹ build.gradle.kts

ç¼–è¾‘ `app/build.gradle.kts`:

```kotlin
android {
    // ... å…¶ä»–é…ç½®
}

dependencies {
    // ... å…¶ä»–ä¾èµ–

    // Sherpa-ONNX AAR
    implementation(files("libs/sherpa-onnx-android-1.10.30.aar"))

    // ONNX Runtime (Sherpa-ONNX ä¾èµ–)
    implementation("com.microsoft.onnxruntime:onnxruntime-android:1.16.0")
}
```

#### 5. åŒæ­¥ Gradle

```bash
./gradlew sync
```

---

### æ–¹æ¡ˆ B: ä½¿ç”¨ JitPack æ„å»ºï¼ˆé«˜çº§ï¼‰

#### 1. æ·»åŠ  JitPack ä»“åº“

åœ¨ `settings.gradle.kts` æˆ–æ ¹ `build.gradle.kts` ä¸­ï¼š

```kotlin
dependencyResolutionManagement {
    repositories {
        google()
        mavenCentral()
        maven { url = uri("https://jitpack.io") }
    }
}
```

#### 2. æ·»åŠ ä¾èµ–

```kotlin
dependencies {
    implementation("com.github.k2-fsa:sherpa-onnx:v1.10.30")
}
```

**æ³¨æ„**: JitPack éœ€è¦æ—¶é—´æ„å»ºï¼Œé¦–æ¬¡å¯èƒ½å¤±è´¥ã€‚

---

### æ–¹æ¡ˆ C: ç®€åŒ–ç‰ˆå®ç°ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœ Sherpa-ONNX é›†æˆå›°éš¾ï¼Œå¯ä»¥å…ˆå®ç°ä¸€ä¸ªæ¨¡æ‹Ÿç‰ˆæœ¬ï¼š

#### 1. åˆ›å»º MockAsrEngine

```kotlin
// app/src/main/java/com/example/aiautominitest/asr/MockAsrEngine.kt
package com.example.aiautominitest.asr

import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow

/**
 * æ¨¡æ‹Ÿ ASR å¼•æ“ï¼ˆç”¨äºæµ‹è¯• UI é€»è¾‘ï¼‰
 */
class MockAsrEngine : IAsrEngine {
    override suspend fun init(modelPath: String): Boolean {
        delay(1000)
        return true
    }

    override fun startRecognition(): Flow<AsrResult> = flow {
        delay(500)
        emit(AsrResult.Partial("ä½ å¥½", false))
        delay(500)
        emit(AsrResult.Partial("ä½ å¥½ï¼Œä¸–ç•Œ", false))
        delay(500)
        emit(AsrResult.Partial("ä½ å¥½ï¼Œä¸–ç•Œï¼", true))
        delay(200)
        emit(AsrResult.Final("ä½ å¥½ï¼Œä¸–ç•Œï¼"))
    }

    override fun stopRecognition() {}
    override fun reset() {}
    override fun release() {}
    override fun isInitialized() = true
}
```

#### 2. ä¿®æ”¹ ChatActivityWithVoice

```kotlin
// å°†è¿™è¡Œ
private val asrEngine = SherpaOnnxAsrEngine()

// æ”¹ä¸º
private val asrEngine = MockAsrEngine()
```

è¿™æ ·å¯ä»¥å…ˆæµ‹è¯• UI é€»è¾‘ï¼Œç­‰ Sherpa-ONNX é›†æˆå¥½åå†åˆ‡æ¢å›æ¥ã€‚

---

## ğŸ“ å®Œæ•´é›†æˆæ­¥éª¤ï¼ˆæ–¹æ¡ˆ Aï¼‰

### Step 1: ä¸‹è½½ Sherpa-ONNX

```bash
cd ~/Downloads
wget https://github.com/k2-fsa/sherpa-onnx/releases/download/v1.10.30/sherpa-onnx-v1.10.30-android.tar.bz2
tar -xjf sherpa-onnx-v1.10.30-android.tar.bz2
```

### Step 2: å¤åˆ¶æ–‡ä»¶åˆ°é¡¹ç›®

```bash
cd AiAutoMiniCPM
mkdir -p app/libs
cp ~/Downloads/sherpa-onnx-v1.10.30-android/sherpa-onnx-android-1.10.30.aar app/libs/
```

### Step 3: æ›´æ–° build.gradle.kts

```kotlin
dependencies {
    // ... å…¶ä»–ä¾èµ–ä¿æŒä¸å˜ ...

    // Sherpa-ONNX
    implementation(files("libs/sherpa-onnx-android-1.10.30.aar"))
    implementation("com.microsoft.onnxruntime:onnxruntime-android:1.16.0")
}
```

### Step 4: åŒæ­¥å¹¶ç¼–è¯‘

```bash
./gradlew sync
./gradlew assembleDebug
```

---

## ğŸ¯ éªŒè¯é›†æˆ

### æ£€æŸ¥ AAR æ˜¯å¦æ­£ç¡®åŠ è½½

```bash
./gradlew app:dependencies --configuration debugCompileClasspath | grep sherpa
```

åº”è¯¥çœ‹åˆ°ï¼š
```
+--- sherpa-onnx-android-1.10.30.aar
```

### æµ‹è¯•ç¼–è¯‘

```bash
./gradlew compileDebugKotlin
```

å¦‚æœæˆåŠŸï¼Œè¯´æ˜ API å¯ç”¨ã€‚

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: AAR æ‰¾ä¸åˆ°ç±»

**é”™è¯¯**:
```
Unresolved reference: OnlineRecognizer
```

**è§£å†³**: æ£€æŸ¥ AAR æ–‡ä»¶æ˜¯å¦æ­£ç¡®æ”¾ç½®åœ¨ `app/libs/` ç›®å½•

### Q2: ONNX Runtime å†²çª

**é”™è¯¯**:
```
Duplicate class com.microsoft.onnxruntime.*
```

**è§£å†³**: ç§»é™¤å…¶ä»– ONNX Runtime ä¾èµ–ï¼Œåªä¿ç•™ä¸€ä¸ªç‰ˆæœ¬

### Q3: Native åº“åŠ è½½å¤±è´¥

**é”™è¯¯**:
```
java.lang.UnsatisfiedLinkError: couldn't find "libsherpa-onnx-jni.so"
```

**è§£å†³**:
1. æ£€æŸ¥ AAR åŒ…å« arm64-v8a æ¶æ„
2. æ¸…ç†é‡æ–°æ„å»ºï¼š`./gradlew clean assembleDebug`

---

## ğŸ“š å‚è€ƒèµ„æº

- **Sherpa-ONNX GitHub**: https://github.com/k2-fsa/sherpa-onnx
- **Android æ–‡æ¡£**: https://k2-fsa.github.io/sherpa/onnx/android/index.html
- **å‘å¸ƒé¡µé¢**: https://github.com/k2-fsa/sherpa-onnx/releases
- **ç¤ºä¾‹ä»£ç **: https://github.com/k2-fsa/sherpa-onnx/tree/master/android/SherpaOnnx

---

## âœ… é›†æˆå®Œæˆæ£€æŸ¥æ¸…å•

- [ ] ä¸‹è½½ Sherpa-ONNX AAR æ–‡ä»¶
- [ ] æ”¾ç½®åˆ° `app/libs/` ç›®å½•
- [ ] æ›´æ–° `build.gradle.kts` æ·»åŠ ä¾èµ–
- [ ] æ·»åŠ  ONNX Runtime ä¾èµ–
- [ ] æ‰§è¡Œ Gradle åŒæ­¥
- [ ] ç¼–è¯‘æˆåŠŸ
- [ ] è¿è¡Œåº”ç”¨æµ‹è¯•è¯­éŸ³åŠŸèƒ½

---

## ğŸš€ ä¸‹ä¸€æ­¥

é›†æˆå®Œæˆåï¼Œç»§ç»­ä»¥ä¸‹æ­¥éª¤ï¼š

1. ä¸‹è½½å¹¶æ”¾ç½® ASR æ¨¡å‹æ–‡ä»¶
2. ä¿®æ”¹ `ChatActivityWithVoice.kt` ä¸­çš„æ¨¡å‹è·¯å¾„
3. å¯ç”¨è¯­éŸ³ç‰ˆèŠå¤©ç•Œé¢
4. æµ‹è¯•è¯­éŸ³è¯†åˆ«åŠŸèƒ½

è¯¦ç»†æ­¥éª¤å‚è€ƒ [è¯­éŸ³åŠŸèƒ½é›†æˆè¯´æ˜.md](è¯­éŸ³åŠŸèƒ½é›†æˆè¯´æ˜.md)ã€‚

---

**ğŸ’¡ æç¤º**: å¦‚æœæ‰‹åŠ¨é›†æˆå›°éš¾ï¼Œå¯ä»¥å…ˆä½¿ç”¨ MockAsrEngine æµ‹è¯• UIï¼Œå¾… Sherpa-ONNX å®˜æ–¹æä¾› Maven ä»“åº“åå†åˆ‡æ¢ã€‚
