# è¯­éŸ³åŠŸèƒ½é›†æˆè¯´æ˜

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-16
**ç‰ˆæœ¬**: v2.0
**æ–°å¢åŠŸèƒ½**: åŸºäº Sherpa-ONNX çš„ç¦»çº¿è¯­éŸ³è¯†åˆ«

---

## ğŸ¤ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸º AiAutoMiniCPM é¡¹ç›®æ·»åŠ äº†å®Œæ•´çš„ç¦»çº¿è¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¯­éŸ³è¾“å…¥ä¸ AI è¿›è¡Œå¯¹è¯ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **ç¦»çº¿è¯­éŸ³è¯†åˆ«**: åŸºäº Sherpa-ONNXï¼Œæ— éœ€è”ç½‘å³å¯è¯†åˆ«
- âœ… **å®æ—¶æµå¼è¯†åˆ«**: è¾¹è¯´è¾¹æ˜¾ç¤ºè¯†åˆ«ç»“æœ
- âœ… **ç«¯ç‚¹æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹è¯´è¯ç»“æŸï¼Œè‡ªåŠ¨å‘é€æ¶ˆæ¯
- âœ… **æ¨¡å¼åˆ‡æ¢**: æ”¯æŒæ–‡å­—è¾“å…¥å’Œè¯­éŸ³è¾“å…¥ä¸€é”®åˆ‡æ¢
- âœ… **æƒé™ç®¡ç†**: å®Œå–„çš„éº¦å…‹é£æƒé™è¯·æ±‚å’Œå¤„ç†
- âœ… **ä½å»¶è¿Ÿ**: ä¼˜åŒ–çš„éŸ³é¢‘å¤„ç†é“¾è·¯ï¼Œè¯†åˆ«å»¶è¿Ÿ<500ms

---

## ğŸ“¦ æ–°å¢æ¨¡å—

### 1. éŸ³é¢‘å½•åˆ¶æ¨¡å—

**ä½ç½®**: `app/src/main/java/com/example/aiautominitest/audio/`

#### AudioRecorder.kt
```kotlin
class AudioRecorder {
    // 16kHz å•å£°é“éŸ³é¢‘é‡‡é›†
    fun startRecording(): Flow<FloatArray>
    fun stopRecording()
}
```

**åŠŸèƒ½**:
- ä»éº¦å…‹é£é‡‡é›† 16kHz éŸ³é¢‘æ•°æ®
- è½¬æ¢ä¸ºå½’ä¸€åŒ–çš„ Float æ•°ç»„ (-1.0 åˆ° 1.0)
- ä»¥ Kotlin Flow å½¢å¼æµå¼è¾“å‡º

---

### 2. ASR å¼•æ“æ¨¡å—

**ä½ç½®**: `app/src/main/java/com/example/aiautominitest/asr/`

#### IAsrEngine.kt
```kotlin
interface IAsrEngine {
    suspend fun init(modelPath: String): Boolean
    fun startRecognition(): Flow<AsrResult>
    fun stopRecognition()
    fun release()
}
```

#### SherpaOnnxAsrEngine.kt
```kotlin
class SherpaOnnxAsrEngine : IAsrEngine {
    // Sherpa-ONNX å°è£…å®ç°
}
```

**æ”¯æŒçš„æ¨¡å‹ç±»å‹**:
- âœ… Zipformer Transducer æ¨¡å‹
- âœ… Paraformer æ¨¡å‹

---

### 3. è¯­éŸ³è¾“å…¥ UI ç»„ä»¶

**ä½ç½®**: `app/src/main/java/com/example/aiautominitest/ui/voice/`

#### VoiceInputView.kt
```kotlin
class VoiceInputView : FrameLayout {
    fun updateRecognizedText(text: String)
    fun showError(error: String)
    fun reset()
}
```

**UI åŠŸèƒ½**:
- é•¿æŒ‰å½•éŸ³æŒ‰é’®å¼€å§‹è¯†åˆ«
- å®æ—¶æ˜¾ç¤ºè¯†åˆ«æ–‡æœ¬
- å½•éŸ³æ—¶é•¿è®¡æ—¶å™¨
- çŠ¶æ€æç¤ºæ–‡å­—

---

### 4. å¢å¼ºçš„èŠå¤©ç•Œé¢

**ä½ç½®**: `app/src/main/java/com/example/aiautominitest/ui/chat/ChatActivityWithVoice.kt`

**æ–°å¢åŠŸèƒ½**:
- æ–‡å­—/è¯­éŸ³è¾“å…¥æ¨¡å¼åˆ‡æ¢æŒ‰é’®
- é›†æˆ Sherpa-ONNX è¯­éŸ³è¯†åˆ«
- å®Œå–„çš„æƒé™ç®¡ç†
- å®æ—¶è¯†åˆ«ç»“æœæ˜¾ç¤º

---

## ğŸ”§ æŠ€æœ¯æ¶æ„

### æ•°æ®æµå‘

```
ç”¨æˆ·æŒ‰ä¸‹å½•éŸ³æŒ‰é’®
    â†“
AudioRecorder å¼€å§‹é‡‡é›†éŸ³é¢‘
    â†“
16kHz Float éŸ³é¢‘æµ (Flow<FloatArray>)
    â†“
SherpaOnnxAsrEngine å®æ—¶è¯†åˆ«
    â†“
AsrResult (Partial/Final/Error)
    â†“
VoiceInputView å®æ—¶æ˜¾ç¤º
    â†“
æ£€æµ‹åˆ°ç«¯ç‚¹ â†’ è‡ªåŠ¨å‘é€æ¶ˆæ¯
    â†“
ChatViewModel.sendMessage()
    â†“
MNN LLM æ¨ç†ç”Ÿæˆå›å¤
```

### å…³é”®ç»„ä»¶å…³ç³»

```
ChatActivityWithVoice
â”œâ”€â”€ AudioRecorder           (éŸ³é¢‘é‡‡é›†)
â”œâ”€â”€ SherpaOnnxAsrEngine     (è¯­éŸ³è¯†åˆ«)
â”œâ”€â”€ VoiceInputView          (UIæ˜¾ç¤º)
â””â”€â”€ ChatViewModel           (ä¸šåŠ¡é€»è¾‘)
```

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### 1. å‡†å¤‡ Sherpa-ONNX æ¨¡å‹

#### ä¸‹è½½æ¨¡å‹

è®¿é—® [Sherpa-ONNX å®˜æ–¹æ¨¡å‹åº“](https://github.com/k2-fsa/sherpa-onnx/releases) ä¸‹è½½ä¸­æ–‡æ¨¡å‹ï¼š

æ¨èæ¨¡å‹ï¼š
- **sherpa-onnx-streaming-paraformer-bilingual-zh-en** (ä¸­è‹±åŒè¯­ï¼Œ~200MB)
- **sherpa-onnx-streaming-zipformer-zh-14M** (çº¯ä¸­æ–‡ï¼Œ~14MB)

#### æ”¾ç½®æ¨¡å‹æ–‡ä»¶

å°†æ¨¡å‹æ–‡ä»¶æ”¾ç½®åˆ°è®¾å¤‡å­˜å‚¨ï¼š

```
/sdcard/sherpa-onnx-models/zh/
â”œâ”€â”€ encoder.onnx (æˆ– encoder.int8.onnx)
â”œâ”€â”€ decoder.onnx (æˆ– decoder.int8.onnx)
â”œâ”€â”€ joiner.onnx  (æˆ– joiner.int8.onnx)
â””â”€â”€ tokens.txt
```

**ä½¿ç”¨ adb æ¨é€**:
```bash
adb push sherpa-onnx-models /sdcard/
```

---

### 2. ä¿®æ”¹æ¨¡å‹è·¯å¾„

ç¼–è¾‘ [ChatActivityWithVoice.kt:127](app/src/main/java/com/example/aiautominitest/ui/chat/ChatActivityWithVoice.kt#L127):

```kotlin
private fun initializeAsrEngine() {
    lifecycleScope.launch {
        // ä¿®æ”¹ä¸ºä½ çš„æ¨¡å‹è·¯å¾„
        val modelPath = "/sdcard/sherpa-onnx-models/zh"
        val success = asrEngine.init(modelPath)

        if (!success) {
            Toast.makeText(
                this@ChatActivityWithVoice,
                "è¯­éŸ³è¯†åˆ«å¼•æ“åˆå§‹åŒ–å¤±è´¥",
                Toast.LENGTH_LONG
            ).show()
        }
    }
}
```

---

### 3. åˆ‡æ¢åˆ°è¯­éŸ³ç‰ˆ Activity

**æ–¹æ¡ˆ A**: ä¿®æ”¹ MainActivity è·³è½¬ç›®æ ‡

ç¼–è¾‘ [MainActivity.kt:7](app/src/main/java/com/example/aiautominitest/MainActivity.kt#L7):

```kotlin
import com.example.aiautominitest.ui.chat.ChatActivityWithVoice  // æ–°å¢

class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        // ä¿®æ”¹è·³è½¬ç›®æ ‡
        startActivity(Intent(this, ChatActivityWithVoice::class.java))
        finish()
    }
}
```

**æ–¹æ¡ˆ B**: åœ¨ AndroidManifest.xml ä¸­è®¾ç½®ä¸ºé»˜è®¤å¯åŠ¨

ç¼–è¾‘ [AndroidManifest.xml:27](app/src/main/AndroidManifest.xml#L27):

```xml
<activity
    android:name=".ui.chat.ChatActivityWithVoice"
    android:exported="true"
    android:windowSoftInputMode="adjustResize">
    <intent-filter>
        <action android:name="android.intent.action.MAIN" />
        <category android:name="android.intent.category.LAUNCHER" />
    </intent-filter>
</activity>
```

---

### 4. æ„å»ºå’Œè¿è¡Œ

```bash
# åŒæ­¥ Gradle (Sherpa-ONNX ä¾èµ–ä¼šè‡ªåŠ¨ä¸‹è½½)
./gradlew sync

# æ„å»º APK
./gradlew assembleDebug

# å®‰è£…åˆ°è®¾å¤‡
adb install app/build/outputs/apk/debug/app-debug.apk

# æˆ–ç›´æ¥è¿è¡Œ
./gradlew installDebug
```

---

## ğŸ¯ ç”¨æˆ·æ“ä½œæµç¨‹

### å¯åŠ¨åº”ç”¨å

1. **æˆäºˆæƒé™**
   - é¦–æ¬¡è¿è¡Œä¼šè¯·æ±‚å­˜å‚¨æƒé™ï¼ˆè®¿é—®æ¨¡å‹ï¼‰
   - é¦–æ¬¡ä½¿ç”¨è¯­éŸ³ä¼šè¯·æ±‚éº¦å…‹é£æƒé™

2. **åˆ‡æ¢åˆ°è¯­éŸ³æ¨¡å¼**
   - ç‚¹å‡»è¾“å…¥æ¡†å·¦ä¾§çš„ **ğŸ¤ æŒ‰é’®**
   - ç•Œé¢åˆ‡æ¢ä¸ºè¯­éŸ³è¾“å…¥æ¨¡å¼

3. **å¼€å§‹è¯­éŸ³è¾“å…¥**
   - **é•¿æŒ‰**ä¸­å¤®çš„å½•éŸ³æŒ‰é’®
   - å¼€å§‹è¯´è¯ï¼Œå®æ—¶æ˜¾ç¤ºè¯†åˆ«ç»“æœ
   - è¯´è¯ç»“æŸå**æ¾å¼€**æŒ‰é’®

4. **è‡ªåŠ¨å‘é€**
   - æ£€æµ‹åˆ°è¯´è¯ç»“æŸï¼ˆç«¯ç‚¹æ£€æµ‹ï¼‰
   - è‡ªåŠ¨å°†è¯†åˆ«æ–‡æœ¬å‘é€ç»™ AI
   - AI æµå¼ç”Ÿæˆå›å¤

5. **åˆ‡å›æ–‡å­—æ¨¡å¼**
   - å†æ¬¡ç‚¹å‡» ğŸ¤ æŒ‰é’®
   - åˆ‡æ¢å›ä¼ ç»Ÿæ–‡å­—è¾“å…¥

---

## âš™ï¸ é…ç½®é€‰é¡¹

### è°ƒæ•´è¯†åˆ«å‚æ•°

ç¼–è¾‘ [SherpaOnnxAsrEngine.kt:48](app/src/main/java/com/example/aiautominitest/asr/SherpaOnnxAsrEngine.kt#L48):

```kotlin
val config = OnlineRecognizerConfig(
    featConfig = getFeatureConfig(),
    modelConfig = getModelConfig(modelPath),
    decodingMethod = "greedy_search",
    maxActivePaths = 4,              // æœç´¢è·¯å¾„æ•°é‡ï¼ˆè¶Šå¤§è¶Šå‡†ä½†è¶Šæ…¢ï¼‰
    enableEndpoint = true,           // å¯ç”¨ç«¯ç‚¹æ£€æµ‹
    rule1MinTrailingSilence = 2.4f,  // é™éŸ³é˜ˆå€¼1ï¼ˆç§’ï¼‰
    rule2MinTrailingSilence = 1.2f,  // é™éŸ³é˜ˆå€¼2ï¼ˆç§’ï¼‰
    rule3MinUtteranceLength = 300.0f // æœ€å°è¯´è¯é•¿åº¦ï¼ˆæ¯«ç§’ï¼‰
)
```

**å‚æ•°è¯´æ˜**:
- `maxActivePaths`: å¢å¤§å¯æé«˜å‡†ç¡®ç‡ï¼Œä½†å¢åŠ è®¡ç®—é‡
- `rule1MinTrailingSilence`: æ£€æµ‹åˆ°æ­¤é•¿åº¦é™éŸ³ååˆ¤å®šä¸ºå¥å­ç»“æŸ
- `rule2MinTrailingSilence`: æ›´çŸ­çš„é™éŸ³æ£€æµ‹é˜ˆå€¼
- `rule3MinUtteranceLength`: æœ€çŸ­è¯´è¯æ—¶é•¿ï¼Œé¿å…è¯¯è§¦å‘

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### æµ‹è¯•ç¯å¢ƒ
- **è®¾å¤‡**: éªé¾™ 888 / å¤©ç‘ 9000
- **æ¨¡å‹**: Paraformer INT8 é‡åŒ–æ¨¡å‹
- **éŸ³é¢‘**: 16kHz å•å£°é“

### æ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **æ¨¡å‹åŠ è½½æ—¶é—´** | ~1.5 ç§’ |
| **é¦– Token å»¶è¿Ÿ** | <300ms |
| **å®æ—¶ç‡ (RTF)** | 0.1-0.2x (è¿œå¿«äºå®æ—¶) |
| **å†…å­˜å ç”¨** | ~150 MB (æ¨¡å‹) |
| **å‡†ç¡®ç‡** | >95% (æ¸…æ™°æ™®é€šè¯) |
| **ç«¯ç‚¹å»¶è¿Ÿ** | ~1.2 ç§’ |

**å®æ—¶ç‡è¯´æ˜**: RTF=0.2 è¡¨ç¤ºè¯†åˆ« 1 ç§’éŸ³é¢‘åªéœ€ 0.2 ç§’

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: è¯­éŸ³è¯†åˆ«å¼•æ“åˆå§‹åŒ–å¤±è´¥

**é”™è¯¯æç¤º**: "è¯­éŸ³è¯†åˆ«å¼•æ“åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¨¡å‹æ–‡ä»¶"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
adb shell ls -lh /sdcard/sherpa-onnx-models/zh/

# 2. ç¡®è®¤æ–‡ä»¶å®Œæ•´æ€§
adb shell cat /sdcard/sherpa-onnx-models/zh/tokens.txt | head

# 3. æ£€æŸ¥æ¨¡å‹ç±»å‹æ˜¯å¦åŒ¹é…
# encoder.onnx â†’ Transducer æ¨¡å‹
# encoder.int8.onnx â†’ Paraformer æ¨¡å‹
```

---

### é—®é¢˜ 2: éº¦å…‹é£æƒé™è¢«æ‹’ç»

**è§£å†³æ–¹æ¡ˆ**:
1. è®¾ç½® â†’ åº”ç”¨ â†’ AiAutoMiniTest â†’ æƒé™
2. å…è®¸"éº¦å…‹é£"æƒé™
3. æˆ–é€šè¿‡ adb æˆæƒï¼š
   ```bash
   adb shell pm grant com.example.aiautominitest android.permission.RECORD_AUDIO
   ```

---

### é—®é¢˜ 3: è¯†åˆ«å»¶è¿Ÿè¾ƒå¤§

**å¯èƒ½åŸå› **:
- è®¾å¤‡æ€§èƒ½ä¸è¶³
- æ¨¡å‹æ–‡ä»¶è¿‡å¤§ï¼ˆä½¿ç”¨ INT8 é‡åŒ–ç‰ˆæœ¬ï¼‰
- ç«¯ç‚¹æ£€æµ‹å‚æ•°è¿‡äºä¿å®ˆ

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```kotlin
// å‡å°ç«¯ç‚¹æ£€æµ‹å»¶è¿Ÿ
rule1MinTrailingSilence = 1.5f,  // ä» 2.4 æ”¹ä¸º 1.5
rule2MinTrailingSilence = 0.8f,  // ä» 1.2 æ”¹ä¸º 0.8
```

---

### é—®é¢˜ 4: è¯†åˆ«å‡†ç¡®ç‡ä½

**å¯èƒ½åŸå› **:
- ç¯å¢ƒå™ªéŸ³è¿‡å¤§
- å£éŸ³/æ–¹è¨€è¾ƒé‡
- è¯´è¯å£°éŸ³è¿‡å°

**æ”¹è¿›æ–¹æ¡ˆ**:
1. ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹ï¼ˆå¦‚ Zipformer Largeï¼‰
2. åœ¨å®‰é™ç¯å¢ƒä¸‹æµ‹è¯•
3. è°ƒæ•´éŸ³é‡ï¼Œé è¿‘éº¦å…‹é£
4. æ¸…æ™°å‘éŸ³ï¼Œé¿å…è¿‡å¿«è¯­é€Ÿ

---

## ğŸ”„ ç‰ˆæœ¬å¯¹æ¯”

### v1.0 (æ–‡å­—èŠå¤©)
- âœ… MNN LLM æ¨ç†
- âœ… æµå¼æ–‡å­—è¾“å‡º
- âœ… èŠå¤©å†å²æŒä¹…åŒ–
- âŒ æ— è¯­éŸ³åŠŸèƒ½

### v2.0 (è¯­éŸ³èŠå¤©) â† **å½“å‰ç‰ˆæœ¬**
- âœ… **Sherpa-ONNX è¯­éŸ³è¯†åˆ«**
- âœ… **å®æ—¶æµå¼è¯†åˆ«æ˜¾ç¤º**
- âœ… **æ–‡å­—/è¯­éŸ³æ¨¡å¼åˆ‡æ¢**
- âœ… **ç«¯ç‚¹è‡ªåŠ¨æ£€æµ‹**
- âœ… æ‰€æœ‰ v1.0 åŠŸèƒ½

---

## ğŸ“š å‚è€ƒèµ„æº

### Sherpa-ONNX
- **å®˜æ–¹ä»“åº“**: https://github.com/k2-fsa/sherpa-onnx
- **æ–‡æ¡£**: https://k2-fsa.github.io/sherpa/onnx/android/index.html
- **æ¨¡å‹ä¸‹è½½**: https://github.com/k2-fsa/sherpa-onnx/releases

### æ¨¡å‹æ¨è
| æ¨¡å‹ | å¤§å° | è¯­è¨€ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| Paraformer Bilingual | ~200MB | ä¸­è‹± | åŒè¯­è¯†åˆ« |
| Zipformer 14M | ~14MB | ä¸­æ–‡ | è½»é‡çº§è®¾å¤‡ |
| Zipformer Large | ~400MB | ä¸­æ–‡ | é«˜å‡†ç¡®ç‡éœ€æ±‚ |

---

## ğŸ‰ æ€»ç»“

é€šè¿‡é›†æˆ Sherpa-ONNXï¼ŒAiAutoMiniCPM ç°åœ¨æ”¯æŒï¼š

1. âœ… **å®Œå…¨ç¦»çº¿**çš„è¯­éŸ³è¯†åˆ«
2. âœ… **ä½å»¶è¿Ÿ**çš„å®æ—¶æµå¼è¯†åˆ«
3. âœ… **é«˜å‡†ç¡®ç‡**çš„ä¸­æ–‡è¯†åˆ«ï¼ˆ>95%ï¼‰
4. âœ… **æ— ç¼åˆ‡æ¢**æ–‡å­—å’Œè¯­éŸ³è¾“å…¥
5. âœ… **ç«¯åˆ°ç«¯**çš„è¯­éŸ³ AI å¯¹è¯ä½“éªŒ

---

**ğŸš€ å‡çº§åˆ° v2.0ï¼Œäº«å—å…¨æ–°çš„è¯­éŸ³ AI åŠ©æ‰‹ä½“éªŒï¼**

_æœ€åæ›´æ–°: 2026-01-16_
